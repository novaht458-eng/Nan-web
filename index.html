<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>nan • Nova Package Registry</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="wrap">
    <h1>nan • Nova Package Registry</h1>

    <section id="auth">
      <h2>Registro / Login</h2>
      <input id="username" placeholder="usuario" />
      <input id="email" placeholder="email (solo registro)" />
      <input id="password" type="password" placeholder="contraseña" />
      <div class="row">
        <button id="btn-register">Registrar</button>
        <button id="btn-login">Login</button>
      </div>
      <div id="auth-msg" class="msg"></div>
    </section>

    <section id="install">
      <h2>Instalar desde web</h2>
      <input id="install-name" placeholder="nombre-paquete@versión" />
      <button id="btn-install">Mostrar comando nan install</button>
      <div id="install-cmd" class="mono"></div>
    </section>

    <footer>
      <small>Somos un equipo de desarrolladores (Nova team). Privacidad real: guardamos sólo lo necesario.</small>
    </footer>
  </main>

<script>
const api = '/.netlify/functions';

const el = id => document.getElementById(id);
const setMsg = (txt, color='black') => { el('auth-msg').innerText = txt; el('auth-msg').style.color = color; };

// Si ya hay sesión -> ir al panel
const saved = localStorage.getItem('user');
if (saved) location.href = '/panel.html';

el('btn-register').addEventListener('click', async () => {
  const username = el('username').value.trim();
  const password = el('password').value.trim();
  const email = el('email').value.trim();
  if (!username || !password) return setMsg('Completa usuario y contraseña', 'red');
  setMsg('Registrando...');
  try {
    const res = await fetch(api + '/register', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ username, password, email })
    });
    const data = await res.json();
    if (data.ok) {
      // guardar y redirigir al panel
      localStorage.setItem('user', data.user);
      localStorage.setItem('apikey', data.apikey || '');
      location.href = '/panel.html';
    } else {
      setMsg(data.error || data.message || JSON.stringify(data), 'red');
    }
  } catch (err) {
    setMsg('Error de conexión', 'red');
  }
});

el('btn-login').addEventListener('click', async () => {
  const username = el('username').value.trim();
  const password = el('password').value.trim();
  if (!username || !password) return setMsg('Completa usuario y contraseña', 'red');
  setMsg('Iniciando sesión...');
  try {
    const res = await fetch(api + '/login', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if (data.ok) {
      localStorage.setItem('user', data.user);
      if (data.apikey) localStorage.setItem('apikey', data.apikey);
      location.href = '/panel.html';
    } else {
      setMsg(data.error || data.message || JSON.stringify(data), 'red');
    }
  } catch (err) {
    setMsg('Error al conectar', 'red');
  }
});

/* Install command */
el('btn-install').addEventListener('click', () => {
  const target = el('install-name').value.trim();
  if (!target) { el('install-cmd').innerText = 'Pon paquete@versión'; return; }
  const site = location.hostname;
  el('install-cmd').innerText = `curl -sL https://${site}/nan-install.sh | bash -s -- install ${target}`;
});
</script>
</body>
</html>
