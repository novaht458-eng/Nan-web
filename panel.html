<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel • nan Registry</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body { background:#0a0a0a; color:#f5f5f5; font-family:system-ui; }
    main.wrap { max-width:800px; margin:auto; padding:2rem; }
    h1,h2,h3 { color:#00d9ff; }
    input,button,textarea {
      background:#1a1a1a; border:1px solid #333; color:#fff;
      padding:0.6rem; border-radius:8px; width:100%;
    }
    button {
      background:#00d9ff; color:#000; font-weight:bold;
      cursor:pointer; transition:0.3s;
    }
    button:hover { background:#00bfe0; }
    section { margin-top:2rem; padding:1rem; background:#111; border-radius:12px; }
    footer { margin-top:2rem; text-align:center; color:#777; }
    .msg { margin-top:0.5rem; color:#0f0; }
    .error { color:#f33; }
    .mono { font-family:monospace; background:#191919; padding:0.5rem; border-radius:6px; }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>nan • Panel del desarrollador</h1>
    <p>Bienvenido <span id="user-name"></span>. Aquí puedes gestionar tus paquetes, generar nuevas API keys y subir tus repositorios.</p>

    <section id="apikey">
      <h3>Tu API Key</h3>
      <div id="api-output" class="mono">Cargando...</div>
      <button id="btn-genapi">Generar nueva API Key</button>
      <p><small>⚠️ Cada API solo puede usarse una vez al subir un paquete. Luego caduca.</small></p>
    </section>

    <section id="upload">
      <h3>Publicar paquete</h3>
      <label>Subir archivo (.zip/.tar) o usar repo (Git)</label>
      <input id="pkg-name" placeholder="nombre-paquete" />
      <input id="pkg-version" placeholder="versión (ej: 1.0.0)" />
      <input id="pkg-desc" placeholder="descripción" />
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <input id="pkg-file" type="file" accept=".zip,.tar,.tar.gz" />
        <input id="pkg-git" placeholder="Repo Git o archive URL (opcional)" />
      </div>
      <input id="pkg-git-token" placeholder="Token para repo privado (opcional)" />
      <button id="btn-publish">Publicar</button>
      <div id="pub-msg" class="msg"></div>
    </section>

    <section id="repos">
      <h3>Mis Paquetes / Repositorios</h3>
      <div id="my-packages" class="mono">Cargando...</div>
    </section>

    <section id="terms">
      <h3>Términos y privacidad</h3>
      <p>nan registra solo datos técnicos mínimos para asegurar la integridad de los paquetes. Las API generadas son personales y temporales.</p>
      <p>Subir un paquete implica aceptar nuestras <a href="#" style="color:#00d9ff;">políticas actualizadas</a>.</p>
    </section>

    <footer>
      <small>nan • Nova Team — 2025</small>
    </footer>
  </main>

  <script>
    const apiOutput = document.getElementById('api-output');
    const pubMsg = document.getElementById('pub-msg');
    const user = localStorage.getItem('nan_user');
    document.getElementById('user-name').textContent = user || 'desarrollador';

    // Cargar API Key actual
    async function loadApi() {
      try {
        const res = await fetch('/.netlify/functions/generateApi?user=' + encodeURIComponent(user));
        const data = await res.json();
        apiOutput.textContent = data.api || '(sin API activa)';
      } catch (e) {
        apiOutput.textContent = 'Error al cargar API.';
      }
    }

    // Generar nueva API
    document.getElementById('btn-genapi').onclick = async () => {
      apiOutput.textContent = 'Generando...';
      try {
        const res = await fetch('/.netlify/functions/generateApi', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ user })
        });
        const data = await res.json();
        apiOutput.textContent = data.api || 'Error generando API';
      } catch (err) {
        apiOutput.textContent = 'Error.';
      }
    };

    // Publicar paquete
    document.getElementById('btn-publish').onclick = async () => {
      pubMsg.textContent = 'Subiendo...';
      const formData = new FormData();
      formData.append('user', user);
      formData.append('api', apiOutput.textContent);
      formData.append('name', document.getElementById('pkg-name').value);
      formData.append('version', document.getElementById('pkg-version').value);
      formData.append('desc', document.getElementById('pkg-desc').value);
      const file = document.getElementById('pkg-file').files[0];
      if (file) formData.append('file', file);
      const git = document.getElementById('pkg-git').value;
      if (git) formData.append('git', git);
      const token = document.getElementById('pkg-git-token').value;
      if (token) formData.append('token', token);

      try {
        const res = await fetch('/.netlify/functions/publish', { method:'POST', body:formData });
        const data = await res.json();
        if (data.ok) {
          pubMsg.textContent = '✅ Paquete publicado correctamente.';
          loadPackages();
        } else {
          pubMsg.textContent = '❌ ' + (data.error || 'Error publicando.');
        }
      } catch {
        pubMsg.textContent = 'Error en conexión.';
      }
    };

    // Cargar lista de paquetes del usuario
    async function loadPackages() {
      try {
        const res = await fetch('/.netlify/functions/servePackage?user=' + encodeURIComponent(user));
        const data = await res.json();
        const list = data.list || [];
        document.getElementById('my-packages').innerHTML = list.length
          ? list.map(x => `• ${x.name}@${x.version}`).join('<br>')
          : '(sin paquetes)';
      } catch {
        document.getElementById('my-packages').textContent = 'Error cargando paquetes.';
      }
    }

    loadApi();
    loadPackages();
  </script>
</body>
</html>
